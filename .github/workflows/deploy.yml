name: ðŸš€ Deploy CRM System

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ·ï¸ Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ”¨ Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}

      - name: ðŸ”¨ Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.lead-schem.ru
            NEXT_PUBLIC_APP_URL=https://lead-schem.ru
            NEXT_PUBLIC_ENVIRONMENT=production
            NEXT_PUBLIC_ENABLE_ANALYTICS=true
            NEXT_PUBLIC_ENABLE_ERROR_REPORTING=true

  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° production ÑÐµÑ€Ð²ÐµÑ€
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    environment: production

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ“‹ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Copy configuration files to server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p /opt/crm-system/nginx/ssl /opt/crm-system/logs /opt/crm-system/backups /opt/crm-system/uploads"
          scp docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/crm-system/
          scp nginx/nginx.conf.template ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/crm-system/nginx/nginx.conf
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cp /etc/letsencrypt/live/lead-schem.ru/fullchain.pem /opt/crm-system/nginx/ssl/ && cp /etc/letsencrypt/live/lead-schem.ru/privkey.pem /opt/crm-system/nginx/ssl/ && chmod 644 /opt/crm-system/nginx/ssl/fullchain.pem && chmod 600 /opt/crm-system/nginx/ssl/privkey.pem && ls -la /opt/crm-system/nginx/ssl/"

      - name: ðŸš€ Deploy to production server
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_REGION: ${{ secrets.S3_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "GITHUB_TOKEN='${{ secrets.GITHUB_TOKEN }}' \
             GITHUB_ACTOR='${{ github.actor }}' \
             DATABASE_URL='${{ secrets.DATABASE_URL }}' \
             JWT_SECRET='${{ secrets.JWT_SECRET }}' \
             REDIS_URL='${{ secrets.REDIS_URL }}' \
             REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}' \
             S3_ENDPOINT='${{ secrets.S3_ENDPOINT }}' \
             S3_REGION='${{ secrets.S3_REGION }}' \
             S3_BUCKET='${{ secrets.S3_BUCKET }}' \
             S3_ACCESS_KEY='${{ secrets.S3_ACCESS_KEY }}' \
             S3_SECRET_KEY='${{ secrets.S3_SECRET_KEY }}' \
             SESSION_SECRET='${{ secrets.SESSION_SECRET }}' \
             bash -s" << 'ENDSSH'
            set -e
            
            echo "ðŸ”„ Starting deployment process..."
            
            cd /opt/crm-system
            
            # Ð‘ÑÐºÐ°Ð¿ Ð¿ÐµÑ€ÐµÐ´ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹)
            if docker compose ps 2>/dev/null | grep -q "Up"; then
              echo "ðŸ’¾ Creating backup before deployment..."
              BACKUP_FILE="backups/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
              tar -czf "$BACKUP_FILE" logs uploads 2>/dev/null || true
              echo "âœ… Backup created: $BACKUP_FILE"
            fi
            
            # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
            echo "ðŸ›‘ Stopping services..."
            docker compose -f docker-compose.prod.yml down 2>/dev/null || true
            docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
            
            # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ñ ÑÑ‚Ð¸Ð¼Ð¸ Ð¸Ð¼ÐµÐ½Ð°Ð¼Ð¸
            echo "ðŸ›‘ Force stopping CRM containers..."
            docker stop crm-nginx crm-backend crm-frontend crm-redis 2>/dev/null || true
            docker rm crm-nginx crm-backend crm-frontend crm-redis 2>/dev/null || true
            
            # Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Docker (Ð‘Ð•Ð— volumes!)
            echo "ðŸ§¹ Cleaning Docker cache (preserving volumes)..."
            docker container prune -f
            docker image prune -f
            docker network prune -f
            docker system prune -af
            docker builder prune -af
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² 80 Ð¸ 443
            echo "ðŸ” Checking ports 80 and 443..."
            if lsof -Pi :80 -sTCP:LISTEN -t >/dev/null 2>&1; then
              echo "âš ï¸ Port 80 is in use, attempting to free..."
              fuser -k 80/tcp 2>/dev/null || true
            fi
            if lsof -Pi :443 -sTCP:LISTEN -t >/dev/null 2>&1; then
              echo "âš ï¸ Port 443 is in use, attempting to free..."
              fuser -k 443/tcp 2>/dev/null || true
            fi
            echo "âœ… Ports are ready"
            
            # Ð›Ð¾Ð³Ð¸Ð½ Ð² GitHub Container Registry
            echo "ðŸ” Logging into GitHub Container Registry..."
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
            
            # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² GitHub
            echo "âš™ï¸ Creating environment file..."
            {
              echo "NODE_ENV=production"
              echo "DATABASE_URL=$DATABASE_URL"
              echo "JWT_SECRET=$JWT_SECRET"
              echo "PORT=3002"
              echo "FRONTEND_URL=https://lead-schem.ru"
              echo "REDIS_URL=redis://:defaultpassword@redis:6379"
              echo "REDIS_PASSWORD=defaultpassword"
              echo "S3_ENDPOINT=$S3_ENDPOINT"
              echo "S3_REGION=$S3_REGION"
              echo "S3_BUCKET=$S3_BUCKET"
              echo "S3_ACCESS_KEY=$S3_ACCESS_KEY"
              echo "S3_SECRET_KEY=$S3_SECRET_KEY"
              echo "BCRYPT_ROUNDS=12"
              echo "SESSION_SECRET=$SESSION_SECRET"
              echo "RATE_LIMIT_WINDOW_MS=900000"
              echo "RATE_LIMIT_MAX_REQUESTS=100"
              echo "LOG_LEVEL=info"
              echo "LOG_FILE_PATH=/var/log/crm/app.log"
            } > .env.production
            
            # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² (ÑÐ°Ð¼Ð¾Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð°)
            if [ ! -f nginx/ssl/cert.pem ]; then
              echo "ðŸ”’ Creating self-signed SSL certificates..."
              echo "âš ï¸  Ð’ÐÐ–ÐÐž: Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ (Let's Encrypt)!"
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout nginx/ssl/private.key \
                -out nginx/ssl/cert.pem \
                -subj "/C=RU/ST=Moscow/L=Moscow/O=CRM/CN=lead-schem.ru"
            fi
            
            # Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            echo "â–¶ï¸ Starting services..."
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            
            # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° backend ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
            echo "â³ Waiting for backend container to start..."
            sleep 10
            
            # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð‘Ð” ÐŸÐžÐ¡Ð›Ð• Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
            echo "ðŸ—„ï¸ Running database migrations..."
            if ! docker exec crm-backend npx prisma migrate deploy 2>&1 | tee /tmp/migrate.log; then
                if grep -q "P3005" /tmp/migrate.log; then
                  echo "âš ï¸ Database is not empty, using db push instead..."
                  docker exec crm-backend npx prisma db push --accept-data-loss || {
                    echo "âŒ Database sync failed!"
                    exit 1
                  }
                  echo "âœ… Database schema synchronized"
                else
                  echo "âŒ Database migration failed!"
                  cat /tmp/migrate.log
                  exit 1
                fi
            else
              echo "âœ… Migrations applied successfully"
            fi
            rm -f /tmp/migrate.log
            
            # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            echo "â³ Waiting for services to be ready..."
            sleep 20
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            echo "ðŸ¥ Health check..."
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° backend (ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾)
            for i in {1..15}; do
              if docker exec crm-backend wget --no-verbose --tries=1 --spider http://localhost:3002/api/health 2>/dev/null; then
                echo "âœ… Backend is healthy"
                break
              fi
              if [ $i -eq 15 ]; then
                echo "âŒ Backend health check failed"
                docker compose -f docker-compose.prod.yml logs backend
                exit 1
              fi
              echo "â³ Waiting for backend... ($i/15)"
              sleep 5
            done
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° frontend (Ð½ÐµÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ð¾)
            echo "ðŸ” Checking frontend status..."
            if docker exec crm-frontend wget --no-verbose --tries=1 --spider http://localhost:3000 2>/dev/null; then
              echo "âœ… Frontend is healthy"
            else
              echo "âš ï¸ Frontend not responding yet (will start shortly)"
              docker compose -f docker-compose.prod.yml logs frontend --tail 20
            fi
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° nginx Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
            echo "ðŸ”„ Reloading nginx..."
            docker compose -f docker-compose.prod.yml restart nginx
            sleep 5
            echo "âœ… Nginx reloaded"
            
            # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐµÑ€Ð²ÐµÑ€Ð°
            echo "ðŸ”„ Setting up autostart on server reboot..."
            if [ ! -f /etc/systemd/system/crm-system.service ]; then
              echo "ðŸ“‹ Creating systemd service for autostart..."
              
              # Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Docker autostart
              systemctl enable docker 2>/dev/null || true
              
              # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ systemd ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ CRM
              cat > /etc/systemd/system/crm-system.service << 'EOFSERVICE'
[Unit]
Description=CRM System (Docker Compose)
Requires=docker.service
After=docker.service network-online.target
Wants=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/crm-system
ExecStartPre=/bin/sleep 10
ExecStart=/usr/bin/docker compose -f docker-compose.prod.yml up -d
ExecStop=/usr/bin/docker compose -f docker-compose.prod.yml down
TimeoutStartSec=300
Restart=on-failure
RestartSec=10s

[Install]
WantedBy=multi-user.target
EOFSERVICE
              
              # Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº
              systemctl daemon-reload
              systemctl enable crm-system.service
              echo "âœ… Autostart configured! CRM will start automatically after server reboot"
            else
              echo "âœ… Autostart already configured"
            fi
            
            # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼ÐµÑÑ‚Ð° Ð½Ð° Ð´Ð¸ÑÐºÐµ
            echo "ðŸ’¾ Disk usage:"
            df -h /opt/crm-system
            
            echo "ðŸŽ‰ Deployment completed successfully!"
            echo "ðŸ“Š Service status:"
            docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: ðŸ”” Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to production completed successfully!"
            echo "ðŸŒ Frontend: https://lead-schem.ru"
            echo "ðŸ”— Backend API: https://api.lead-schem.ru"
          else
            echo "âŒ Deployment failed!"
            echo "ðŸ’¡ Check the logs above for details"
          fi