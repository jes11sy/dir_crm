name: ğŸš€ Deploy CRM System

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ·ï¸ Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ”¨ Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}

      # Frontend Docker Ğ¾Ğ±Ñ€Ğ°Ğ·
      - name: ğŸ”¨ Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

  # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° production ÑĞµÑ€Ğ²ĞµÑ€
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    environment: production

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“‹ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to production server
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ”„ Starting deployment process..."
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ĞµÑĞ»Ğ¸ ĞµÑ‘ Ğ½ĞµÑ‚
            mkdir -p /opt/crm-system
            cd /opt/crm-system
            
            # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
            echo "ğŸ›‘ Stopping services..."
            docker compose down 2>/dev/null || true
            
            # Ğ¥Ğ°Ñ€Ğ´ Ñ€ĞµÑĞµÑ‚ Docker (Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° ĞºÑÑˆĞ°)
            echo "ğŸ§¹ Hard reset Docker cache..."
            docker system prune -af --volumes
            docker builder prune -af
            
            # Ğ›Ğ¾Ğ³Ğ¸Ğ½ Ğ² GitHub Container Registry
            echo "ğŸ” Logging into GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ docker-compose.prod.yml
            echo "ğŸ“ Creating docker-compose.prod.yml..."
            cat > docker-compose.prod.yml << 'COMPOSE_EOF'
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: crm-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - backend
    networks:
      - crm-network
    restart: unless-stopped

  frontend:
    image: ghcr.io/jes11sy/dir_crm/frontend:latest
    container_name: crm-frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://api.lead-schem.ru
      - NEXT_PUBLIC_APP_URL=https://lead-schem.ru
    networks:
      - crm-network
    restart: unless-stopped

  backend:
    image: ghcr.io/jes11sy/dir_crm/backend:latest
    container_name: crm-backend
    env_file:
      - .env.production
    volumes:
      - ./logs:/var/log/crm
      - ./uploads:/app/uploads
    networks:
      - crm-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: crm-redis
    command: redis-server --requirepass $${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - crm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  postgres:
    image: postgres:15-alpine
    container_name: crm-postgres
    environment:
      - POSTGRES_DB=crm
      - POSTGRES_USER=$${DB_USER}
      - POSTGRES_PASSWORD=$${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - crm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data:
  redis-data:

networks:
  crm-network:
    driver: bridge
COMPOSE_EOF
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ¸Ğ· ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² GitHub
            echo "âš™ï¸ Creating environment file..."
            cat > .env.production << EOL
          NODE_ENV=production
          
          # Database
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          
          # JWT
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          
          # Server
          PORT=3002
          FRONTEND_URL="https://lead-schem.ru"
          
          # Redis
          REDIS_URL="${{ secrets.REDIS_URL }}"
          REDIS_PASSWORD="${{ secrets.REDIS_PASSWORD }}"
          
          # S3 Storage
          S3_ENDPOINT="${{ secrets.S3_ENDPOINT }}"
          S3_REGION="${{ secrets.S3_REGION }}"
          S3_BUCKET="${{ secrets.S3_BUCKET }}"
          S3_ACCESS_KEY="${{ secrets.S3_ACCESS_KEY }}"
          S3_SECRET_KEY="${{ secrets.S3_SECRET_KEY }}"
          
          # Security
          BCRYPT_ROUNDS=12
          SESSION_SECRET="${{ secrets.SESSION_SECRET }}"
          
          # Rate Limiting
          RATE_LIMIT_WINDOW_MS=900000
          RATE_LIMIT_MAX_REQUESTS=100
          
          # Logging
          LOG_LEVEL=info
          LOG_FILE_PATH="/var/log/crm/app.log"
          EOL
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ .env Ğ´Ğ»Ñ frontend
            cat > frontend/.env.production << EOL
          NEXT_PUBLIC_API_URL=https://api.lead-schem.ru
          NEXT_PUBLIC_APP_URL=https://lead-schem.ru
          NEXT_PUBLIC_ENVIRONMENT=production
          NEXT_PUBLIC_ENABLE_ANALYTICS=true
          NEXT_PUBLIC_ENABLE_ERROR_REPORTING=true
          EOL
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
            echo "ğŸ“ Creating directories..."
            mkdir -p logs nginx/ssl backups uploads
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ nginx.conf
            echo "ğŸ“ Creating nginx.conf..."
            cat > nginx/nginx.conf << 'NGINX_EOF'
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$$remote_addr - $$remote_user [$$time_local] "$$request" '
                    '$$status $$body_bytes_sent "$$http_referer" '
                    '"$$http_user_agent" "$$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    gzip on;
    
    # Frontend
    server {
        listen 80;
        server_name lead-schem.ru www.lead-schem.ru;
        return 301 https://$$server_name$$request_uri;
    }
    
    server {
        listen 443 ssl http2;
        server_name lead-schem.ru www.lead-schem.ru;
        
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/private.key;
        
        location / {
            proxy_pass http://frontend:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $$http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $$host;
            proxy_cache_bypass $$http_upgrade;
        }
    }
    
    # Backend API
    server {
        listen 80;
        server_name api.lead-schem.ru;
        return 301 https://$$server_name$$request_uri;
    }
    
    server {
        listen 443 ssl http2;
        server_name api.lead-schem.ru;
        
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/private.key;
        
        location / {
            proxy_pass http://backend:3002;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $$http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $$host;
            proxy_cache_bypass $$http_upgrade;
            proxy_set_header X-Real-IP $$remote_addr;
            proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $$scheme;
        }
    }
}
NGINX_EOF
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² (ÑĞ°Ğ¼Ğ¾Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°)
            if [ ! -f nginx/ssl/cert.pem ]; then
              echo "ğŸ”’ Creating SSL certificates..."
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout nginx/ssl/private.key \
                -out nginx/ssl/cert.pem \
                -subj "/C=RU/ST=Moscow/L=Moscow/O=CRM/CN=lead-schem.ru"
            fi
            
            # Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
            echo "â–¶ï¸ Starting services..."
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            
            # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
            echo "â³ Waiting for services to be ready..."
            sleep 30
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
            echo "ğŸ¥ Health check..."
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° backend
            for i in {1..10}; do
              if curl -f -s http://localhost:3002/api/health > /dev/null; then
                echo "âœ… Backend is healthy"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âŒ Backend health check failed"
                docker compose -f docker-compose.prod.yml logs backend
                exit 1
              fi
              sleep 10
            done
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° frontend
            for i in {1..10}; do
              if curl -f -s http://localhost:3000 > /dev/null; then
                echo "âœ… Frontend is healthy"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âŒ Frontend health check failed"
                docker compose -f docker-compose.prod.yml logs frontend
                exit 1
              fi
              sleep 10
            done
            
            # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸ“Š Service status:"
            docker compose -f docker-compose.prod.yml ps
          EOF

      - name: ğŸ”” Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to production completed successfully!"
            echo "ğŸŒ Frontend: https://lead-schem.ru"
            echo "ğŸ”— Backend API: https://api.lead-schem.ru"
          else
            echo "âŒ Deployment failed!"
          fi
