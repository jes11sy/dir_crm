# Roadmap CRM для директора по работе с заявками

## Обзор проекта
CRM система для управления заявками, мастерами, кассой и отчетностью. 
**Стэк:** Next.js 14 + TypeScript + shadcn/ui + reui + originui, Node.js + Express + Prisma, PostgreSQL + Redis

---

## Этап 1: Настройка проекта и инфраструктуры

### 1.1 Инициализация проекта
- [x] Создать Next.js 14 проект с TypeScript
- [x] Настроить структуру папок (app/, components/, lib/, types/)
- [x] Установить и настроить shadcn/ui
- [x] Установить и настроить reui
- [x] Установить и настроить originui
- [x] Настроить Tailwind CSS
- [x] Создать базовую структуру компонентов

### 1.2 Настройка backend
- [x] Создать Express.js сервер
- [x] Настроить TypeScript для backend
- [x] Установить и настроить Prisma ORM
- [x] Настроить подключение к PostgreSQL
- [x] Установить и настроить Redis
- [x] Создать базовую структуру API routes

### 1.3 Настройка базы данных
- [x] Проанализировать существующую схему PostgreSQL
- [x] Создать/обновить Prisma schema для CRM
- [x] Добавить новые таблицы:
  - [x] **Director** (id, city, name, login, password, contract_doc, passport_doc, date_create, note)
  - [x] **Master** (id, city, name, passport_doc, contract_doc, status_work, date_create, note)
  - [x] **Cash** (id, name, amount, note, receipt_doc, date_create, name_create)
- [x] Создать миграции для новых таблиц
- [x] Настроить связи между таблицами (Director-Master, Master-Orders, Cash-Orders)
- [x] Создать seed данные для тестирования

---

## Этап 2: Аутентификация и базовая структура

### 2.1 Система аутентификации
- [x] Создать страницу логина с использованием shadcn/ui + reui + originui
- [x] Реализовать аутентификацию через таблицу Director (login/password)
- [x] Реализовать JWT токены для аутентификации
- [x] Создать middleware для проверки авторизации
- [x] Настроить защищенные роуты
- [x] Реализовать logout функциональность
- [x] Добавить хеширование паролей директоров

### 2.2 Базовая навигация
- [x] Создать верхнее меню с разделами:
  - [x] Заказы
  - [x] Касса (подвкладки: История, Расход, Приход)
  - [x] Сотрудники (мастера)
  - [x] Отчеты (подвкладки: Отчет по городу, Отчет по мастерам)
- [x] Настроить роутинг между страницами
- [x] Создать layout компонент

---

## Этап 3: Модуль заказов

### 3.1 Таблица заказов
- [x] Создать компонент таблицы заказов с колонками:
  - [x] id rk (РК)
  - [x] city (Город)
  - [x] avito_name (имя авито)
  - [x] phone (телефон)
  - [x] type_order (тип заявки)
  - [x] client_name (имя клиента)
  - [x] address (адрес)
  - [x] date_meeting (дата встречи)
  - [x] type_equipment (тип техники)
  - [x] problem (проблема)
  - [x] status_order (статус заказа)
  - [x] master_id (имя мастера)
  - [x] result (число)

### 3.2 Функциональность заказов
- [x] Реализовать фильтрацию заказов
- [x] Добавить поиск по заказам
- [x] Реализовать сортировку по колонкам
- [x] Добавить пагинацию
- [x] Создать модальные окна для просмотра/редактирования заказов
- [x] Реализовать распределение заявок между мастерами
- [x] Добавить ручное закрытие заявки
- [x] Создать API endpoints для CRUD операций с заказами

---

## Этап 4: Модуль кассы ✅

### 4.1 История операций
- [x] Использовать существующую таблицу Cash для истории операций
- [x] Реализовать отображение списка операций из таблицы Cash
- [x] Добавить фильтрацию по датам и типам операций (name: приход/расход)
- [x] Создать детальный просмотр операций
- [x] Добавить отображение receipt_doc и name_create

### 4.2 Управление расходами
- [x] Создать форму добавления расхода в таблицу Cash (name="расход")
- [x] Реализовать валидацию данных (amount, note, receipt_doc)
- [x] Добавить поле name_create для указания создателя расхода
- [x] Создать API для управления расходами
- [x] Реализовать редактирование и удаление расходов

### 4.3 Управление приходами
- [x] Создать форму добавления прихода в таблицу Cash (name="приход")
- [x] Связать приходы с заказами через note поле
- [x] Реализовать автоматическое создание приходов при закрытии заказов
- [x] Создать API для управления приходами
- [x] Добавить загрузку receipt_doc для приходов

---

## Этап 5: Модуль сотрудников ✅

### 5.1 Управление мастерами
- [x] Использовать существующую таблицу Master
- [x] Реализовать добавление нового мастера с полями: city, name, passport_doc, contract_doc, status_work, note
- [x] Создать форму редактирования данных мастера
- [x] Реализовать изменение status_work для увольнения мастера
- [x] Добавить валидацию данных мастера (обязательные поля: name, city)
- [x] Создать API для CRUD операций с мастерами
- [x] Добавить загрузку документов (passport_doc, contract_doc)

### 5.2 Связь мастеров с заказами
- [x] Реализовать назначение мастера на заказ
- [x] Создать историю работы мастера
- [x] Добавить статистику по мастерам

---

## Этап 6: Модуль отчетности ✅

### 6.1 Отчет по городу
- [x] Создать таблицу с данными:
  - [x] Название города
  - [x] Количество закрытых заказов
  - [x] Средний чек
  - [x] Оборот
  - [x] Доход компании
- [x] Реализовать группировку данных по городам
- [x] Добавить фильтрацию по периодам
- [x] Создать экспорт отчетов

### 6.2 Отчет по мастерам
- [x] Создать таблицу с данными:
  - [x] Имя мастера
  - [x] Количество заказов
  - [x] Оборот
  - [x] Средний чек
  - [x] Зарплата
- [x] Реализовать расчет зарплаты мастера
- [x] Добавить фильтрацию по периодам
- [x] Создать детальную статистику по мастеру

---

## Этап 7: Интеграция и оптимизация

### 7.1 Интеграция с существующей CRM
- [ ] Проанализировать существующую схему БД
- [ ] Создать миграции для совместимости
- [ ] Реализовать синхронизацию данных
- [ ] Настроить общие таблицы

### 7.2 Кэширование и производительность
- [ ] Настроить Redis для кэширования
- [ ] Оптимизировать запросы к БД
- [ ] Реализовать ленивую загрузку данных
- [ ] Добавить индексы в БД для ускорения запросов

### 7.3 UI/UX улучшения
- [ ] Добавить loading состояния
- [ ] Реализовать error handling
- [ ] Создать responsive дизайн
- [ ] Добавить анимации и переходы
- [ ] Оптимизировать для мобильных устройств

---

## Этап 8: Финальная настройка

### 8.1 Валидация и безопасность
- [ ] Добавить валидацию всех форм
- [ ] Реализовать rate limiting
- [ ] Настроить CORS
- [ ] Добавить логирование действий пользователей
- [ ] Реализовать backup стратегию

### 8.2 Документация
- [ ] Создать API документацию
- [ ] Написать README с инструкциями по запуску
- [ ] Создать пользовательскую документацию
- [ ] Добавить комментарии в код

### 8.3 Финальное тестирование
- [ ] Протестировать все CRUD операции
- [ ] Проверить корректность расчетов в отчетах
- [ ] Протестировать интеграцию с существующей CRM
- [ ] Проверить производительность системы
- [ ] Протестировать на разных устройствах и браузерах

---

## Технические детали

### Структура базы данных

#### Новые таблицы для CRM:
- **Director:** (id, city, name, login, password, contract_doc, passport_doc, date_create, note)
- **Master:** (id, city, name, passport_doc, contract_doc, status_work, date_create, note)  
- **Cash:** (id, name, amount, note, receipt_doc, date_create, name_create)

#### Существующие таблицы (из колл-центра CRM):
- **Order:** (id, rk, city, avito_name, phone, type_order, client_name, address, date_meeting, type_equipment, problem, status_order, master_id, result, expenditure, clean, bso_doc, expenditure_doc, operator_name_id, create_date, closing_data)
- **CallcentreOperator:** (id, name, login, password, city, status, status_work, passport, contract, date_create, sip_address)
- **Call:** (id, rk, city, avito_name, phone_client, phone_ats, date_create, operator_id, status, mango_call_id)
- **Avito:** (id, name, client_id, client_secret, proxy_type, proxy_host, proxy_port, proxy_login, proxy_password, connection_status, proxy_status, account_balance, ads_count, views_count, contacts_count, views_today, contacts_today, last_sync_at, user_id)
- **Phone:** (id, number, rk, city, avito_name)
- **Mango:** (id, call_id, phone_number, direction, duration, record_url, status, mango_data)
- **EmailSettings:** (id, host, port, secure, user, password, mango_email, check_interval, enabled)

### API Endpoints
- `/api/orders` - управление заказами (существующие)
- `/api/masters` - управление мастерами (новая таблица Master)
- `/api/cash` - управление кассой (новая таблица Cash)
- `/api/directors` - управление директорами (новая таблица Director)
- `/api/reports` - генерация отчетов
- `/api/auth` - аутентификация через Director

### Компоненты UI
- `OrderTable` - таблица заказов
- `MasterForm` - форма мастера
- `CashForm` - форма кассовых операций
- `ReportTable` - таблицы отчетов
- `Navigation` - навигационное меню
- `LoginForm` - форма входа

---

## Временные рамки
- **Этап 1-2:** 1-2 недели
- **Этап 3:** 2-3 недели  
- **Этап 4:** 1-2 недели
- **Этап 5:** 1 неделя
- **Этап 6:** 2 недели
- **Этап 7-8:** 1-2 недели

**Общее время разработки:** 8-12 недель
